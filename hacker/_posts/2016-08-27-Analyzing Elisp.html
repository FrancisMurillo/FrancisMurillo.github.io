---
title: Analyzing Elisp
tagline: Making an Elisp parser just to see what code can be written
layout: post
author: Francis Murillo
categories: Emacs, Hacker
blog-category: hacker
tags: Emacs
---

<div id="outline-container-org031e1ed" class="outline-2">
<h2 id="org031e1ed">Idea</h2>
<div class="outline-text-2" id="text-org031e1ed">
<p>
I like poetry. It is art and I love it. I like reading. It is writing
and I love it. So are programmers not writers? Sort of.
</p>

<p>
Recently, I just read <a href="https://www.amazon.com/Your-Code-Crime-Scene-Bottlenecks/dp/1680500384">Your Code As A Crime Scene</a> and I am breathless
on what you can do by analyzing source code. It has practical value in
getting a project landscape as well as being smarter on how code
evolves on a project. The concepts such as <b>coupling</b>, <b>churn</b> and
<b>ownership</b> are really compelling. As such, I am planning to implement
a <a href="https://github.com/FrancisMurillo/code-maater.el">code-maater.el</a> library so I can practice how to make a major mode in
Emacs as well as get a grip on how to use <a href="https://github.com/adamtornhill/code-maat">code-maat</a> and its tools.
</p>

<p>
This motivated me also to analyze Elisp code as a tribute to it and
experiment. My fundamental question is: <b>is there complexity analysis
in Elisp?</b> Before you get excited, in all honesty I have no idea what
I am getting at. Merely creating a parser albeit a simple one for lisp
is what drove me here. I'm good but not that good.
</p>
</div>
</div>

<div id="outline-container-org2981e39" class="outline-2">
<h2 id="org2981e39">Code Ideas</h2>
<div class="outline-text-2" id="text-org2981e39">
<p>
So here the things I though of when thinking about static Elisp
analysis
</p>

<dl class="org-dl">
<dt><b>Atom Frequency</b></dt><dd>What atoms are in a file. And probably there frequency.</dd>
<dt><b>Expression Complexity</b></dt><dd>Is there a simple metric involving atoms and depth as a way to
measure complexity?</dd>
<dt><b>Code Manipulation</b></dt><dd>Can you manipulate the source tree? A common question and concept.</dd>
</dl>

<p>
With that in mind, I will need a parser and a project to analyze.
Maybe a shameless plug, I will use my created Elisp parser project
<a href="https://github.com/FrancisMurillo/elk.el">elk.el</a> and analyze the source code with it. We programmers love the
meta programming or analysis.
</p>

<p>
Again, I have no idea what I'm doing so just enjoy the flow of questions.
</p>
</div>
</div>

<div id="outline-container-orgb81bccf" class="outline-2">
<h2 id="orgb81bccf">Parser</h2>
<div class="outline-text-2" id="text-orgb81bccf">
<p>
So while I was a making this parser, I learned how to use <a href="https://github.com/cask/cask">cask</a> and
<a href="https://travis-ci.org/">travis-ci</a> to make this project. What I did is to separate the parsing
module against the token analysis library which I dub <a href="https://github.com/FrancisMurillo/elk-magic.el">elk-magic.el</a> and
not another shameless plug.
</p>

<p>
Since this parser is just something to get me started analyzing source
code, I did not take the terminology of the facts and figures probably
right. I know how to implement the parser using recursion. At this
time, I really don't know what it is called or what I am doing. All I
expect is a function that accepts a source code and churns out tokens
in a stream. Such is a functional programmer in me but if I may make
mistakes in terminology or concept, I would be happy to be corrected.
I really just want to see what happens in the source code, I am not
planning to create an interpreter.
</p>

<p>
Here are some terminology that I came across.
</p>

<dl class="org-dl">
<dt><b>Tokens</b></dt><dd>Everything the source code might be interested in. This is the
main data type expressed as a plist.</dd>
<dt><b>Comment</b></dt><dd>Lines starting with <code>; Comment\n</code></dd>
<dt><b>Whitespace</b></dt><dd>Everything between the tokens</dd>
<dt><b>Text</b></dt><dd>A text or string if you'd like to call it that <code>"Hello World"</code></dd>
<dt><b>Atom</b></dt><dd>A symbol or a number, basically what you put in <code>(atom atom atom)</code></dd>
<dt><b>Quotes</b></dt><dd>The unary expression in Elisp <code>`back-quoting</code>, <code>'quoting</code> or <code>#'function-quote</code></dd>
<dt><b>Expressions</b></dt><dd>The s-exp of the source code, recursion is prevalent here.</dd>
</dl>

<p>
I am aware that <b>Numbers</b> are not in the list but I do not care about
the actual data type for this analysis. One could put a mapper on the
tokens just to analyze what data type an atom would be but I am
interested in the syntax tokens rather than what they really are and I
know that is more complicated I needed.
</p>

<p>
Honestly, you don't need to care about the problems when I implemented
the parser but for those interested.
</p>

<dl class="org-dl">
<dt><b>Character Escaping</b></dt><dd>Handling <code>\</code>, <code>?</code> or <code>?\</code> made this project harder to implement
but should have expected that.</dd>
<dt><b>Infinite Recursion</b></dt><dd>Sometimes the code hangs when there is an error recursively
tokenizing the code. Unit testing and modularity would have
helped me a lot in my development time</dd>
</dl>

<p>
And probably more but those two I should have considered while I was
thinking about it. Beside that, implementation of a recursive parser
is easy enough but obviously not perfect. After creating the unit
tests, I am confident enough that it parses source code 90% of the
time.
</p>

<p>
As an experiment, I tried parsing <code>alert</code>, <code>helm-projectile</code>,
<code>prodigy</code> and my own source code and it doesn't hang and gets it
right. So with this meaningless parser prelude, let's get into the
meat of the topic. Source code analysis. All experimental source code
is in <code>elk-magic.el</code> with the tag <a href="https://github.com/FrancisMurillo/elk-magic.el/tree/analyzing-elisp-post">analyzing-elisp-post</a>.
</p>
</div>
</div>

<div id="outline-container-org8723e29" class="outline-2">
<h2 id="org8723e29">Atom Frequency</h2>
<div class="outline-text-2" id="text-org8723e29">
<p>
Let's start with a simple list.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #ff8c00;">(</span>a b c a<span style="color: #ff8c00;">)</span>
</pre>
</div>

<p>
The main parsing function, <code>elk-parse</code>, will yield the hypothetical
list of tokens or plists. The structure should be evident or reflect
lisp itself with some extra annotation.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #ff8c00;">(</span>cl-prettyprint <span style="color: #ff1493;">(</span>elk-parse <span style="color: #68f6cb;">"(a b c)"</span><span style="color: #ff1493;">)</span><span style="color: #ff8c00;">)</span>

<span style="color: #2872b2;">;; </span><span style="color: #2872b2;">Too lazy to pretty it properly</span>
<span style="color: #ff8c00;">(</span><span style="color: #ff1493;">(</span><span style="color: #96a5d9; font-style: italic;">:type</span> expression
        <span style="color: #96a5d9; font-style: italic;">:tokens</span>
        <span style="color: #7fff00;">(</span><span style="color: #00bfff;">(</span><span style="color: #96a5d9; font-style: italic;">:type</span> atom
                <span style="color: #96a5d9; font-style: italic;">:tokens</span>
                nil
                <span style="color: #96a5d9; font-style: italic;">:start-pos</span>
                1
                <span style="color: #96a5d9; font-style: italic;">:end-pos</span>
                2
                <span style="color: #96a5d9; font-style: italic;">:index</span>
                0
                <span style="color: #96a5d9; font-style: italic;">:level</span>
                2
                <span style="color: #96a5d9; font-style: italic;">:id</span>
                2
                <span style="color: #96a5d9; font-style: italic;">:parent-id</span>
                1
                <span style="color: #96a5d9; font-style: italic;">:text</span>
                <span style="color: #68f6cb;">"a"</span>
                <span style="color: #96a5d9; font-style: italic;">:data-type</span>
                symbol<span style="color: #00bfff;">)</span>
         <span style="color: #00bfff;">(</span><span style="color: #96a5d9; font-style: italic;">:type</span> whitespace
                <span style="color: #96a5d9; font-style: italic;">:tokens</span>
                nil
                <span style="color: #96a5d9; font-style: italic;">:start-pos</span>
                2
                <span style="color: #96a5d9; font-style: italic;">:end-pos</span>
                3
                <span style="color: #96a5d9; font-style: italic;">:index</span>
                1
                <span style="color: #96a5d9; font-style: italic;">:level</span>
                2
                <span style="color: #96a5d9; font-style: italic;">:id</span>
                3
                <span style="color: #96a5d9; font-style: italic;">:parent-id</span>
                1
                <span style="color: #96a5d9; font-style: italic;">:text</span>
                <span style="color: #68f6cb;">" "</span><span style="color: #00bfff;">)</span>
         <span style="color: #00bfff;">(</span><span style="color: #96a5d9; font-style: italic;">:type</span> atom
                <span style="color: #96a5d9; font-style: italic;">:tokens</span>
                nil
                <span style="color: #96a5d9; font-style: italic;">:start-pos</span>
                3
                <span style="color: #96a5d9; font-style: italic;">:end-pos</span>
                4
                <span style="color: #96a5d9; font-style: italic;">:index</span>
                2
                <span style="color: #96a5d9; font-style: italic;">:level</span>
                2
                <span style="color: #96a5d9; font-style: italic;">:id</span>
                4
                <span style="color: #96a5d9; font-style: italic;">:parent-id</span>
                1
                <span style="color: #96a5d9; font-style: italic;">:text</span>
                <span style="color: #68f6cb;">"b"</span>
                <span style="color: #96a5d9; font-style: italic;">:data-type</span>
                symbol<span style="color: #00bfff;">)</span>
         <span style="color: #00bfff;">(</span><span style="color: #96a5d9; font-style: italic;">:type</span> whitespace
                <span style="color: #96a5d9; font-style: italic;">:tokens</span>
                nil
                <span style="color: #96a5d9; font-style: italic;">:start-pos</span>
                4
                <span style="color: #96a5d9; font-style: italic;">:end-pos</span>
                5
                <span style="color: #96a5d9; font-style: italic;">:index</span>
                3
                <span style="color: #96a5d9; font-style: italic;">:level</span>
                2
                <span style="color: #96a5d9; font-style: italic;">:id</span>
                5
                <span style="color: #96a5d9; font-style: italic;">:parent-id</span>
                1
                <span style="color: #96a5d9; font-style: italic;">:text</span>
                <span style="color: #68f6cb;">" "</span><span style="color: #00bfff;">)</span>
         <span style="color: #00bfff;">(</span><span style="color: #96a5d9; font-style: italic;">:type</span> atom
                <span style="color: #96a5d9; font-style: italic;">:tokens</span>
                nil
                <span style="color: #96a5d9; font-style: italic;">:start-pos</span>
                5
                <span style="color: #96a5d9; font-style: italic;">:end-pos</span>
                6
                <span style="color: #96a5d9; font-style: italic;">:index</span>
                4
                <span style="color: #96a5d9; font-style: italic;">:level</span>
                2
                <span style="color: #96a5d9; font-style: italic;">:id</span>
                6
                <span style="color: #96a5d9; font-style: italic;">:parent-id</span>
                1
                <span style="color: #96a5d9; font-style: italic;">:text</span>
                <span style="color: #68f6cb;">"c"</span>
                <span style="color: #96a5d9; font-style: italic;">:data-type</span>
                symbol<span style="color: #00bfff;">)</span><span style="color: #7fff00;">)</span>
        <span style="color: #96a5d9; font-style: italic;">:start-pos</span>
        0
        <span style="color: #96a5d9; font-style: italic;">:end-pos</span>
        -1
        <span style="color: #96a5d9; font-style: italic;">:index</span>
        0
        <span style="color: #96a5d9; font-style: italic;">:level</span>
        1
        <span style="color: #96a5d9; font-style: italic;">:id</span>
        1
        <span style="color: #96a5d9; font-style: italic;">:parent-id</span>
        0<span style="color: #ff1493;">)</span><span style="color: #ff8c00;">)</span>
</pre>
</div>

<p>
Take your time in guessing the structure of the token because it takes
too much time to explain. I do want to point your attention to the
plists with type <code>'atom</code>. Given this structure, how do we get all the
tokens in this list. Do think about it while I present the first code
from <code>elk-magic.el</code>.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #ff8c00;">(</span><span style="color: #96a5d9; font-weight: bold;">defun</span> <span style="color: #bad6e2;">elk--select-type</span> <span style="color: #ff1493;">(</span>type tokens<span style="color: #ff1493;">)</span>
  <span style="color: #68f6cb; font-style: italic;">"Filter tokens by a specified type"</span>
  <span style="color: #ff1493;">(</span>funcall <span style="color: #7fff00;">(</span>-compose
            <span style="color: #00bfff;">(</span>-partial #'-filter
                      <span style="color: #ffff00;">(</span><span style="color: #96a5d9; font-weight: bold;">lambda</span> <span style="color: #da70d6;">(</span>token<span style="color: #da70d6;">)</span>
                        <span style="color: #da70d6;">(</span>eq <span style="color: #00ff7f;">(</span>plist-get token <span style="color: #96a5d9; font-style: italic;">:type</span><span style="color: #00ff7f;">)</span> type<span style="color: #da70d6;">)</span><span style="color: #ffff00;">)</span><span style="color: #00bfff;">)</span>
            #'elk--flatten-tokens<span style="color: #7fff00;">)</span>
           tokens<span style="color: #ff1493;">)</span><span style="color: #ff8c00;">)</span>

<span style="color: #ff8c00;">(</span><span style="color: #96a5d9; font-weight: bold;">defun</span> <span style="color: #bad6e2;">elk--extract-atoms</span> <span style="color: #ff1493;">(</span>tokens<span style="color: #ff1493;">)</span>
  <span style="color: #68f6cb; font-style: italic;">"Get atoms in tokens"</span>
  <span style="color: #ff1493;">(</span>funcall <span style="color: #7fff00;">(</span>-compose
            <span style="color: #00bfff;">(</span>-partial #'-map <span style="color: #ffff00;">(</span>-rpartial #'plist-get <span style="color: #96a5d9; font-style: italic;">:text</span><span style="color: #ffff00;">)</span><span style="color: #00bfff;">)</span>
            <span style="color: #00bfff;">(</span>-partial #'elk--select-type 'atom<span style="color: #00bfff;">)</span><span style="color: #7fff00;">)</span>
           tokens<span style="color: #ff1493;">)</span><span style="color: #ff8c00;">)</span>


<span style="color: #ff8c00;">(</span>cl-prettyprint <span style="color: #ff1493;">(</span>elk--extract-atoms <span style="color: #7fff00;">(</span>elk-parse <span style="color: #68f6cb;">"(a b c)"</span><span style="color: #7fff00;">)</span><span style="color: #ff1493;">)</span><span style="color: #ff8c00;">)</span>

<span style="color: #ff8c00;">(</span><span style="color: #68f6cb;">"a"</span> <span style="color: #68f6cb;">"b"</span> <span style="color: #68f6cb;">"c"</span><span style="color: #ff8c00;">)</span>
</pre>
</div>

<p>
Using the functional style of recursion and mapping, I traverse the
tree and get the source code text and the function does return an
expected list that reflects the actual structure of the code. But this
is not exciting. As promised, let's apply this to <code>elk.el</code>. Here is
the output while I group and sort it by frequency.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #ff8c00;">(</span><span style="color: #96a5d9; font-weight: bold;">defconst</span> <span style="color: #ff694d;">elk-file-url</span> <span style="color: #68f6cb;">"https://raw.githubusercontent.com/FrancisMurillo/elk.el/analyzing-elisp-post/elk.el"</span><span style="color: #ff8c00;">)</span>
<span style="color: #ff8c00;">(</span><span style="color: #96a5d9; font-weight: bold;">defconst</span> <span style="color: #ff694d;">elk-file</span> <span style="color: #68f6cb;">"~/Downloads/elk.el"</span><span style="color: #ff8c00;">)</span>

<span style="color: #ff8c00;">(</span><span style="color: #96a5d9; font-weight: bold;">require</span> '<span style="color: #afc0fd; font-weight: bold;">f</span><span style="color: #ff8c00;">)</span>
<span style="color: #ff8c00;">(</span>cl-prettyprint <span style="color: #ff1493;">(</span>elk-magic-summarize-atoms <span style="color: #7fff00;">(</span>elk-parse <span style="color: #00bfff;">(</span>f-read-text elk-file<span style="color: #00bfff;">)</span><span style="color: #7fff00;">)</span><span style="color: #ff1493;">)</span><span style="color: #ff8c00;">)</span>

<span style="color: #2872b2;">;; </span><span style="color: #2872b2;">So here is the token frequency</span>
<span style="color: #ff8c00;">(</span><span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"stream"</span> . 61<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"elk--use-stream"</span> . 37<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"defun"</span> . 34<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"token"</span> . 32<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"tokens"</span> . 29<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"letter"</span> . 27<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"current-char"</span> . 25<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"nil"</span> . 24<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"text"</span> . 24<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"this-char"</span> . 23<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"setf"</span> . 22<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"lambda"</span> . 18<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"start-pos"</span> . 18<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"recurser"</span> . 18<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"current"</span> . 17<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"sub-tokens"</span> . 16<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"type"</span> . 14<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">":tokens"</span> . 13<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"when"</span> . 12<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"incremented-index"</span> . 10<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"not"</span> . 9<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"-copy"</span> . 9<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"stop"</span> . 8<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"elk--create-token"</span> . 8<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"end-pos"</span> . 7<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">":type"</span> . 7<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"letrec"</span> . 7<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"new-token"</span> . 7<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"marked-token"</span> . 7<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"lexical-let"</span> . 6<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"quote-text"</span> . 6<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"expression"</span> . 6<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"index"</span> . 5<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"command"</span> . 5<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"pcase"</span> . 5<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"require"</span> . 4<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"current-value"</span> . 4<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"0"</span> . 4<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"&amp;optional"</span> . 4<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"t"</span> . 4<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"base-value"</span> . 4<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"elk--stream-next-p"</span> . 4<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"elk--quote-p"</span> . 4<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"next-char"</span> . 4<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"elk--dispatch-stream-consumers"</span> . 4<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"value"</span> . 4<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"-map"</span> . 4<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"leveled-token"</span> . 4<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"_"</span> . 4<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"seed"</span> . 4<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"indexed-token"</span> . 4<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"elk--text-stream"</span> . 3<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"current-text"</span> . 3<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"text-length"</span> . 3<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"increment"</span> . 3<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"peek"</span> . 3<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">":end-pos"</span> . 3<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"elk--whitespace-p"</span> . 3<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"elk--text-quote-p"</span> . 3<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"elk--text-escape-p"</span> . 3<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"elk--letter-escape-p"</span> . 3<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"elk--atom-letter-p"</span> . 3<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"start-letter"</span> . 3<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"expression-tokens"</span> . 3<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">":text"</span> . 3<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"level"</span> . 3<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"generator"</span> . 3<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"texify"</span> . 3<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"elk-current-tokens"</span> . 3<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"elk"</span> . 2<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"elk--stream-consumers"</span> . 2<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"elk--consume-whitespace"</span> . 2<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"elk--consume-comment"</span> . 2<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"elk--consume-text"</span> . 2<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"elk--consume-quote"</span> . 2<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"elk--consume-atom"</span> . 2<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"elk--consume-expression"</span> . 2<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"base"</span> . 2<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"incrementer"</span> . 2<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"default"</span> . 2<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"-1"</span> . 2<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"elk--stream-stop-p"</span> . 2<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">":start-pos"</span> . 2<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"elk--comment-p"</span> . 2<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"elk--newline-p"</span> . 2<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"elk--function-quote-p"</span> . 2<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"elk--back-quote-p"</span> . 2<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"elk--expression-start-p"</span> . 2<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"elk--expression-close-p"</span> . 2<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"whitespace"</span> . 2<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"comment"</span> . 2<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"base-token"</span> . 2<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">":quote-text"</span> . 2<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"push"</span> . 2<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"handler"</span> . 2<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"elk--attach-source"</span> . 2<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"elk--attach-level"</span> . 2<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"1"</span> . 2<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"elk--attach-token-id"</span> . 2<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"incremental-sequence"</span> . 2<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"start"</span> . 2<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"parent-id"</span> . 2<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">":id"</span> . 2<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"elk--attach-expression-index"</span> . 2<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"elk--attach-atom-type"</span> . 2<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"typer"</span> . 2<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"number"</span> . 2<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"elk--parsing"</span> . 2<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"elk--parse"</span> . 2<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"parsing"</span> . 2<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"-compose"</span> . 2<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"-partial"</span> . 2<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"text-tokens"</span> . 2<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"source-text"</span> . 2<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"cl-lib"</span> . 1<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"dash"</span> . 1<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"dash-functional"</span> . 1<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"s"</span> . 1<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"defgroup"</span> . 1<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">":prefix"</span> . 1<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">":group"</span> . 1<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"tools"</span> . 1<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">":link"</span> . 1<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"url-link"</span> . 1<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">":tag"</span> . 1<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"elk--started-stream"</span> . 1<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"s-matches-p"</span> . 1<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"unless"</span> . 1<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">":level"</span> . 1<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">":parent-id"</span> . 1<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"-map-indexed"</span> . 1<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">":index"</span> . 1<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"zerop"</span> . 1<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"symbol"</span> . 1<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">":data-type"</span> . 1<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"elk--codify"</span> . 1<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"s-join"</span> . 1<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"-flatten"</span> . 1<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"elk-parse"</span> . 1<span style="color: #ff1493;">)</span>
 <span style="color: #ff1493;">(</span><span style="color: #68f6cb;">"region-active-p"</span> . 1<span style="color: #ff1493;">)</span><span style="color: #ff8c00;">)</span>
</pre>
</div>

<p>
A lot of tokens indeed! So the question is: <b>what does this tell us?</b>
First of, there is already a lot of junk such function
parameters(<code>:level</code>, <code>&amp;optional</code>), numbers(<code>0</code>, <code>1</code>) and other known
functions(<code>defun</code>, <code>not</code>). So to say this is expected but again what
does it mean for a token to be frequent or otherwise?
</p>

<p>
Honestly, I don't know. I do want to know what keywords best identify
a source code. I guess I am merely grasping at straws here. I could
tighten up the filter for what is a meaningful atom but I could still
run in the same problem.
</p>

<p>
An unoriginal idea would be to create an linter on what keywords or
names should be allowed such as enforcing a schema but I don't want to
go there.
</p>

<p>
So first idea is a bust.
</p>
</div>
</div>

<div id="outline-container-org3fc724c" class="outline-2">
<h2 id="org3fc724c">Expression Complexity</h2>
<div class="outline-text-2" id="text-org3fc724c">
<p>
This is another wild idea but the gist is that <b>given an s-exp, is
there a metric to compute complexity?</b> I am not computer science
professor but a simple metric can go like this and remember atoms have
a level property.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #ff8c00;">(</span><span style="color: #96a5d9; font-weight: bold;">defun</span> <span style="color: #bad6e2;">elk-magic--token-depth</span> <span style="color: #ff1493;">(</span>token<span style="color: #ff1493;">)</span>
  <span style="color: #68f6cb; font-style: italic;">"Find out the TOKEN depth or the maximum number of level it has."</span>
  <span style="color: #ff1493;">(</span><span style="color: #96a5d9; font-weight: bold;">letrec</span> <span style="color: #7fff00;">(</span><span style="color: #00bfff;">(</span>recurser
       <span style="color: #ffff00;">(</span><span style="color: #96a5d9; font-weight: bold;">lambda</span> <span style="color: #da70d6;">(</span>token<span style="color: #da70d6;">)</span>
         <span style="color: #da70d6;">(</span><span style="color: #96a5d9; font-weight: bold;">let*</span> <span style="color: #00ff7f;">(</span><span style="color: #ff8247;">(</span>token-level <span style="color: #9cb6ad;">(</span>plist-get token <span style="color: #96a5d9; font-style: italic;">:level</span><span style="color: #9cb6ad;">)</span><span style="color: #ff8247;">)</span>
             <span style="color: #ff8247;">(</span>sub-tokens <span style="color: #9cb6ad;">(</span>plist-get token <span style="color: #96a5d9; font-style: italic;">:tokens</span><span style="color: #9cb6ad;">)</span><span style="color: #ff8247;">)</span>
             <span style="color: #ff8247;">(</span>sub-token-depths
              <span style="color: #9cb6ad;">(</span>-map recurser sub-tokens<span style="color: #9cb6ad;">)</span><span style="color: #ff8247;">)</span><span style="color: #00ff7f;">)</span>
           <span style="color: #00ff7f;">(</span><span style="color: #96a5d9; font-weight: bold;">if</span> sub-token-depths
               <span style="color: #ff8247;">(</span>-max sub-token-depths<span style="color: #ff8247;">)</span>
             token-level<span style="color: #00ff7f;">)</span><span style="color: #da70d6;">)</span><span style="color: #ffff00;">)</span><span style="color: #00bfff;">)</span><span style="color: #7fff00;">)</span>
    <span style="color: #7fff00;">(</span>funcall recurser token<span style="color: #7fff00;">)</span><span style="color: #ff1493;">)</span><span style="color: #ff8c00;">)</span>

<span style="color: #ff8c00;">(</span><span style="color: #96a5d9; font-weight: bold;">defun</span> <span style="color: #bad6e2;">elk-magic--token-atoms</span> <span style="color: #ff1493;">(</span>token<span style="color: #ff1493;">)</span>
  <span style="color: #68f6cb; font-style: italic;">"Find out the TOKEN child atoms up to the last depth."</span>
  <span style="color: #ff1493;">(</span><span style="color: #96a5d9; font-weight: bold;">letrec</span> <span style="color: #7fff00;">(</span><span style="color: #00bfff;">(</span>recurser
       <span style="color: #ffff00;">(</span><span style="color: #96a5d9; font-weight: bold;">lambda</span> <span style="color: #da70d6;">(</span>token<span style="color: #da70d6;">)</span>
         <span style="color: #da70d6;">(</span><span style="color: #96a5d9; font-weight: bold;">let*</span> <span style="color: #00ff7f;">(</span><span style="color: #ff8247;">(</span>token-type <span style="color: #9cb6ad;">(</span>plist-get token <span style="color: #96a5d9; font-style: italic;">:type</span><span style="color: #9cb6ad;">)</span><span style="color: #ff8247;">)</span>
             <span style="color: #ff8247;">(</span>sub-tokens <span style="color: #9cb6ad;">(</span>plist-get token <span style="color: #96a5d9; font-style: italic;">:tokens</span><span style="color: #9cb6ad;">)</span><span style="color: #ff8247;">)</span><span style="color: #00ff7f;">)</span>
           <span style="color: #00ff7f;">(</span><span style="color: #96a5d9; font-weight: bold;">if</span> <span style="color: #ff8247;">(</span>eq token-type 'atom<span style="color: #ff8247;">)</span>
               <span style="color: #ff8247;">(</span>list token<span style="color: #ff8247;">)</span>
             <span style="color: #ff8247;">(</span>apply #'append <span style="color: #9cb6ad;">(</span>-map recurser sub-tokens<span style="color: #9cb6ad;">)</span><span style="color: #ff8247;">)</span><span style="color: #00ff7f;">)</span><span style="color: #da70d6;">)</span><span style="color: #ffff00;">)</span><span style="color: #00bfff;">)</span><span style="color: #7fff00;">)</span>
    <span style="color: #7fff00;">(</span>funcall recurser token<span style="color: #7fff00;">)</span><span style="color: #ff1493;">)</span><span style="color: #ff8c00;">)</span>


<span style="color: #ff8c00;">(</span><span style="color: #96a5d9; font-weight: bold;">defun</span> <span style="color: #bad6e2;">elk-magic--token-complexity</span> <span style="color: #ff1493;">(</span>token<span style="color: #ff1493;">)</span>
  <span style="color: #68f6cb; font-style: italic;">"Compute expression or TOKEN complexity."</span>
  <span style="color: #ff1493;">(</span><span style="color: #96a5d9; font-weight: bold;">let*</span> <span style="color: #7fff00;">(</span><span style="color: #00bfff;">(</span>atoms <span style="color: #ffff00;">(</span>elk-magic--token-atoms token<span style="color: #ffff00;">)</span><span style="color: #00bfff;">)</span>
      <span style="color: #00bfff;">(</span>root-level <span style="color: #ffff00;">(</span>plist-get token <span style="color: #96a5d9; font-style: italic;">:level</span><span style="color: #ffff00;">)</span><span style="color: #00bfff;">)</span>
      <span style="color: #00bfff;">(</span>atom-complexity <span style="color: #ffff00;">(</span>/ <span style="color: #da70d6;">(</span>float <span style="color: #00ff7f;">(</span>length atoms<span style="color: #00ff7f;">)</span><span style="color: #da70d6;">)</span><span style="color: #ffff00;">)</span><span style="color: #00bfff;">)</span><span style="color: #7fff00;">)</span>
    <span style="color: #7fff00;">(</span>-sum
     <span style="color: #00bfff;">(</span>-map <span style="color: #ffff00;">(</span><span style="color: #96a5d9; font-weight: bold;">lambda</span> <span style="color: #da70d6;">(</span>atom<span style="color: #da70d6;">)</span>
             <span style="color: #da70d6;">(</span><span style="color: #96a5d9; font-weight: bold;">let*</span> <span style="color: #00ff7f;">(</span><span style="color: #ff8247;">(</span>depth <span style="color: #9cb6ad;">(</span>- <span style="color: #ff8c00;">(</span>plist-get atom <span style="color: #96a5d9; font-style: italic;">:level</span><span style="color: #ff8c00;">)</span> root-level<span style="color: #9cb6ad;">)</span><span style="color: #ff8247;">)</span>
                 <span style="color: #ff8247;">(</span>depth-complexity depth<span style="color: #ff8247;">)</span><span style="color: #00ff7f;">)</span>
               <span style="color: #00ff7f;">(</span>* atom-complexity depth-complexity<span style="color: #00ff7f;">)</span><span style="color: #da70d6;">)</span><span style="color: #ffff00;">)</span>
           atoms<span style="color: #00bfff;">)</span><span style="color: #7fff00;">)</span><span style="color: #ff1493;">)</span><span style="color: #ff8c00;">)</span>
</pre>
</div>

<p>
In short, the sum of <code>((/ number-of-tokens) * (/ current-atom-level
  main-expression-level))</code>. The idea is weighted atom levels. By giving
each atom a weight based on the number of atoms in total and factoring
in on how nested that atom is, it should be a good guess of
complexity. I guess. So for a quick gist, let's apply it to the
snippet above.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #2872b2;">;; </span><span style="color: #2872b2;">Code from above</span>
<span style="color: #ff8c00;">(</span><span style="color: #96a5d9; font-weight: bold;">defconst</span> <span style="color: #ff694d;">snippet-code</span> <span style="color: #ff1493;">(</span>buffer-substring-no-properties <span style="color: #7fff00;">(</span>region-beginning<span style="color: #7fff00;">)</span> <span style="color: #7fff00;">(</span>region-end<span style="color: #7fff00;">)</span><span style="color: #ff1493;">)</span><span style="color: #ff8c00;">)</span>

<span style="color: #ff8c00;">(</span>cl-prettyprint <span style="color: #ff1493;">(</span>mapcar #'elk-magic--token-complexity <span style="color: #7fff00;">(</span>elk-parse snippet-code<span style="color: #7fff00;">)</span><span style="color: #ff1493;">)</span><span style="color: #ff8c00;">)</span>

<span style="color: #2872b2;">;; </span><span style="color: #2872b2;">0 are the whitespace, whitespace has no complexity or is there?</span>
<span style="color: #ff8c00;">(</span>0
 6.357142857142854 <span style="color: #2872b2;">; </span><span style="color: #2872b2;">elk-magic--token-depth</span>
 0
 6.599999999999997 <span style="color: #2872b2;">; </span><span style="color: #2872b2;">elk-magic--token-atoms</span>
 0
 5.727272727272726 <span style="color: #2872b2;">; </span><span style="color: #2872b2;">elk-magic--token-complexity</span>
 <span style="color: #ff8c00;">)</span>
</pre>
</div>

<p>
Again what does a 5 or 6 tell us? We need more context.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #2872b2;">;; </span><span style="color: #2872b2;">A normal list</span>
<span style="color: #ff8c00;">(</span>cl-prettyprint <span style="color: #ff1493;">(</span>mapcar #'elk-magic--token-complexity
                        <span style="color: #7fff00;">(</span>elk-parse <span style="color: #68f6cb;">"(1 2 3 4)"</span><span style="color: #7fff00;">)</span><span style="color: #ff1493;">)</span><span style="color: #ff8c00;">)</span>
<span style="color: #2872b2;">; </span><span style="color: #2872b2;">Result</span>
<span style="color: #ff8c00;">(</span>1.0<span style="color: #ff8c00;">)</span>

<span style="color: #ff8c00;">(</span>cl-prettyprint <span style="color: #ff1493;">(</span>mapcar #'elk-magic--token-complexity
                        <span style="color: #7fff00;">(</span>elk-parse <span style="color: #68f6cb;">"'a-regular-atom"</span><span style="color: #7fff00;">)</span><span style="color: #ff1493;">)</span><span style="color: #ff8c00;">)</span>
<span style="color: #2872b2;">; </span><span style="color: #2872b2;">Result</span>
<span style="color: #ff8c00;">(</span>1.0<span style="color: #ff8c00;">)</span> <span style="color: #2872b2;">; </span><span style="color: #2872b2;">Baseline</span>


<span style="color: #2872b2;">;; </span><span style="color: #2872b2;">A require</span>
<span style="color: #ff8c00;">(</span>cl-prettyprint <span style="color: #ff1493;">(</span>mapcar #'elk-magic--token-complexity
                        <span style="color: #7fff00;">(</span>elk-parse <span style="color: #68f6cb;">"(require 'elk)"</span><span style="color: #7fff00;">)</span><span style="color: #ff1493;">)</span><span style="color: #ff8c00;">)</span>
<span style="color: #2872b2;">; </span><span style="color: #2872b2;">Result</span>
<span style="color: #ff8c00;">(</span>1.5<span style="color: #ff8c00;">)</span>


<span style="color: #2872b2;">;; </span><span style="color: #2872b2;">A normal function</span>
<span style="color: #ff8c00;">(</span>cl-prettyprint <span style="color: #ff1493;">(</span>mapcar #'elk-magic--token-complexity
                        <span style="color: #7fff00;">(</span>elk-parse <span style="color: #68f6cb;">"(defun hello-elk () (interactive) (message \"Hello Elk\"))"</span><span style="color: #7fff00;">)</span><span style="color: #ff1493;">)</span><span style="color: #ff8c00;">)</span>
<span style="color: #2872b2;">; </span><span style="color: #2872b2;">Result</span>
<span style="color: #ff8c00;">(</span>1.5<span style="color: #ff8c00;">)</span>


<span style="color: #2872b2;">;; </span><span style="color: #2872b2;">A battle of recursion</span>
<span style="color: #ff8c00;">(</span><span style="color: #96a5d9; font-weight: bold;">require</span> '<span style="color: #afc0fd; font-weight: bold;">subr-x</span><span style="color: #ff8c00;">)</span>
<span style="color: #ff8c00;">(</span>cl-prettyprint <span style="color: #ff1493;">(</span>mapcar #'elk-magic--token-complexity
                        <span style="color: #7fff00;">(</span>elk-parse <span style="color: #00bfff;">(</span>string-trim-left <span style="color: #68f6cb;">"</span>
<span style="color: #68f6cb;">(defun factorial-linear (n)</span>
<span style="color: #68f6cb;">  (interactive)</span>
<span style="color: #68f6cb;">  (let ((value 1)</span>
<span style="color: #68f6cb;">        (counter 1 ))</span>
<span style="color: #68f6cb;">    (while (&lt;= counter n)</span>
<span style="color: #68f6cb;">      (setf value (* value counter))</span>
<span style="color: #68f6cb;">      (setf counter (1+ counter)))))"</span><span style="color: #00bfff;">)</span><span style="color: #7fff00;">)</span><span style="color: #ff1493;">)</span><span style="color: #ff8c00;">)</span>
<span style="color: #2872b2;">; </span><span style="color: #2872b2;">Result</span>
<span style="color: #ff8c00;">(</span>3.6363636363636376<span style="color: #ff8c00;">)</span> <span style="color: #2872b2;">; </span><span style="color: #2872b2;">Impretive is not that complicated</span>

<span style="color: #ff8c00;">(</span>cl-prettyprint <span style="color: #ff1493;">(</span>mapcar #'elk-magic--token-complexity
                        <span style="color: #7fff00;">(</span>elk-parse <span style="color: #00bfff;">(</span>string-trim-left <span style="color: #68f6cb;">"</span>
<span style="color: #68f6cb;">(defun factorial-recursive (n)</span>
<span style="color: #68f6cb;">  (interactive)</span>
<span style="color: #68f6cb;">  (if (zerop n) 1</span>
<span style="color: #68f6cb;">    (* n (factorial-recursive (1- n))))</span>
<span style="color: #68f6cb;">  )"</span><span style="color: #00bfff;">)</span><span style="color: #7fff00;">)</span><span style="color: #ff1493;">)</span><span style="color: #ff8c00;">)</span>
<span style="color: #2872b2;">; </span><span style="color: #2872b2;">Result</span>
<span style="color: #ff8c00;">(</span>2.769230769230769<span style="color: #ff8c00;">)</span> <span style="color: #2872b2;">; </span><span style="color: #2872b2;">Functional is less complicated!?</span>


<span style="color: #2872b2;">;; </span><span style="color: #2872b2;">Very nested</span>
<span style="color: #ff8c00;">(</span>cl-prettyprint <span style="color: #ff1493;">(</span>mapcar #'elk-magic--token-complexity
                        <span style="color: #7fff00;">(</span>elk-parse <span style="color: #00bfff;">(</span>string-trim-left <span style="color: #68f6cb;">"</span>
<span style="color: #68f6cb;">(1 (2 (3 (4 (5 (6 (7 (8 (9 (10 (11 (12 (13 (14 (15 (16))))))))))))))))"</span><span style="color: #00bfff;">)</span><span style="color: #7fff00;">)</span><span style="color: #ff1493;">)</span><span style="color: #ff8c00;">)</span>
<span style="color: #2872b2;">; </span><span style="color: #2872b2;">Result</span>
<span style="color: #ff8c00;">(</span>8.5<span style="color: #ff8c00;">)</span> <span style="color: #2872b2;">; </span><span style="color: #2872b2;">Complicated indeed</span>
</pre>
</div>

<p>
So the results are more encouraging than the previous but again what
does this tell us? I still don't know but here is what I think.
</p>

<ul class="org-ul">
<li><b>If it is around 1 to 5</b>, the code is considered <b>simple</b></li>
<li><b>If it is around 6 to 8</b>, the code is <b>non-trivial</b></li>
<li><b>Anything higher than 8</b>, the code is <b>complex</b></li>
</ul>

<p>
The case may vary and no one can really say if the code should be
complex or simple, that is in experience but having a simple metric is
kinda nice. I do want to say that this metric has its flaws and can be
faked but again it is nice. One can compute the average complexity of
a code and then track it over time or simply get the a static
complexity landscape. Or one can just do an ocular and say this code
needs refactoring. Nothing beats experience I think.
</p>

<p>
Quite encouraging for a simple experiment. I say as well that this
might beat whitespace analysis if people prefer condensed code. I
don't know but for now this is good.
</p>
</div>
</div>

<div id="outline-container-orgfce7a27" class="outline-2">
<h2 id="orgfce7a27">Code Manipulation</h2>
<div class="outline-text-2" id="text-orgfce7a27">
<p>
If you have the syntax tree then you can manipulate it, right? This is
the common use of a syntax tree but can also be used as a formatter
but Elisp already has this. I can give two trivial examples which
kinda makes this implementing in a more Emacs way fun.
</p>

<ul class="org-ul">
<li>Nearest top level expression at point</li>
<li>Manipulating the code</li>
</ul>

<p>
The first one is very easy.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #ff8c00;">(</span><span style="color: #96a5d9; font-weight: bold;">defun</span> <span style="color: #bad6e2;">elk-magic--nearest-top-expression-at-point</span> <span style="color: #ff1493;">()</span>
  <span style="color: #68f6cb; font-style: italic;">"Get token expression that is nearest to the highest point"</span>
  <span style="color: #ff1493;">(</span><span style="color: #96a5d9; font-weight: bold;">interactive</span><span style="color: #ff1493;">)</span>
  <span style="color: #ff1493;">(</span><span style="color: #96a5d9; font-weight: bold;">let*</span> <span style="color: #7fff00;">(</span><span style="color: #00bfff;">(</span>source-text <span style="color: #ffff00;">(</span>buffer-substring-no-properties <span style="color: #da70d6;">(</span>point-min<span style="color: #da70d6;">)</span> <span style="color: #da70d6;">(</span>point-max<span style="color: #da70d6;">)</span><span style="color: #ffff00;">)</span><span style="color: #00bfff;">)</span>
         <span style="color: #00bfff;">(</span>tokens <span style="color: #ffff00;">(</span>elk-parse source-text<span style="color: #ffff00;">)</span><span style="color: #00bfff;">)</span>
         <span style="color: #00bfff;">(</span>expression-token <span style="color: #ffff00;">(</span>-first <span style="color: #da70d6;">(</span><span style="color: #96a5d9; font-weight: bold;">lambda</span> <span style="color: #00ff7f;">(</span>token<span style="color: #00ff7f;">)</span>
                                     <span style="color: #00ff7f;">(</span><span style="color: #96a5d9; font-weight: bold;">and</span> <span style="color: #ff8247;">(</span>= <span style="color: #9cb6ad;">(</span>plist-get token <span style="color: #96a5d9; font-style: italic;">:level</span><span style="color: #9cb6ad;">)</span> 1<span style="color: #ff8247;">)</span>
                                          <span style="color: #ff8247;">(</span>eq <span style="color: #9cb6ad;">(</span>plist-get token <span style="color: #96a5d9; font-style: italic;">:type</span><span style="color: #9cb6ad;">)</span> 'expression<span style="color: #ff8247;">)</span>
                                          <span style="color: #ff8247;">(</span>&lt;= <span style="color: #9cb6ad;">(</span>plist-get token <span style="color: #96a5d9; font-style: italic;">:start-pos</span><span style="color: #9cb6ad;">)</span> <span style="color: #9cb6ad;">(</span>point<span style="color: #9cb6ad;">)</span><span style="color: #ff8247;">)</span>
                                          <span style="color: #ff8247;">(</span>&gt;= <span style="color: #9cb6ad;">(</span>plist-get token <span style="color: #96a5d9; font-style: italic;">:end-pos</span><span style="color: #9cb6ad;">)</span> <span style="color: #9cb6ad;">(</span>point<span style="color: #9cb6ad;">)</span><span style="color: #ff8247;">)</span><span style="color: #00ff7f;">)</span><span style="color: #da70d6;">)</span>
                                   tokens<span style="color: #ffff00;">)</span><span style="color: #00bfff;">)</span><span style="color: #7fff00;">)</span>
    <span style="color: #7fff00;">(</span><span style="color: #96a5d9; font-weight: bold;">if</span> expression-token
        <span style="color: #00bfff;">(</span>goto-char <span style="color: #ffff00;">(</span>1+ <span style="color: #da70d6;">(</span>plist-get expression-token <span style="color: #96a5d9; font-style: italic;">:start-pos</span><span style="color: #da70d6;">)</span><span style="color: #ffff00;">)</span><span style="color: #00bfff;">)</span>
      <span style="color: #00bfff;">(</span>message <span style="color: #68f6cb;">"No near top level expression at point"</span><span style="color: #00bfff;">)</span><span style="color: #7fff00;">)</span><span style="color: #ff1493;">)</span><span style="color: #ff8c00;">)</span>

<span style="color: #2872b2;">; </span><span style="color: #2872b2;">Complexity: 6.377777777777779 (Non-trivial)</span>
</pre>
</div>

<p>
Just simply parse the code, filter the highest level expressions with
the ones between the point, and simply point at the <code>start-pos</code>. The
sad thing is that if the code is large this has to parse the whole
code just to figure out where to land. There is an easier way with
<code>paredit</code>.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #ff8c00;">(</span><span style="color: #96a5d9; font-weight: bold;">defun</span> <span style="color: #bad6e2;">paredit--nearest-top-level-expression-at-point</span> <span style="color: #ff1493;">()</span>
  <span style="color: #68f6cb; font-style: italic;">"Above but using paredit"</span>
  <span style="color: #ff1493;">(</span><span style="color: #96a5d9; font-weight: bold;">interactive</span><span style="color: #ff1493;">)</span>
  <span style="color: #ff1493;">(</span><span style="color: #96a5d9; font-weight: bold;">condition-case</span> ex
      <span style="color: #7fff00;">(</span><span style="color: #96a5d9; font-weight: bold;">while</span> t <span style="color: #00bfff;">(</span>paredit-backward-up<span style="color: #00bfff;">)</span><span style="color: #7fff00;">)</span>
    <span style="color: #7fff00;">(</span>'error nil<span style="color: #7fff00;">)</span><span style="color: #ff1493;">)</span><span style="color: #ff8c00;">)</span>
<span style="color: #2872b2;">; </span><span style="color: #2872b2;">Complexity: 2.5(Simple)</span>
</pre>
</div>

<p>
Even, the complexity metric says this. Wow&#x2026; just goes to show Emacs
rocks. You don't need the syntax tree just to move around the code.
But how about something more juicy but not really useful
</p>

<p>
Let's say we have this snippet.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #ff8c00;">(</span><span style="color: #96a5d9; font-weight: bold;">defun</span> <span style="color: #bad6e2;">x</span> <span style="color: #ff1493;">()</span> nil<span style="color: #ff8c00;">)</span>

<span style="color: #ff8c00;">(</span><span style="color: #96a5d9; font-weight: bold;">defvar</span> <span style="color: #ff694d;">y</span> nil<span style="color: #ff8c00;">)</span>
</pre>
</div>

<p>
Nothing special right? Yeah. For the sake of example, how about we
want to namespace it&#x2026; say with <code>z</code>? Let's use the syntax tree.
</p>

<p>
This be way harder than just doing a macro replace, I am not selling
myself that much huh?
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #ff8c00;">(</span><span style="color: #96a5d9; font-weight: bold;">defun</span> <span style="color: #bad6e2;">namespacer</span> <span style="color: #ff1493;">(</span>namespace<span style="color: #ff1493;">)</span>
  <span style="color: #ff1493;">(</span><span style="color: #96a5d9; font-weight: bold;">interactive</span><span style="color: #ff1493;">)</span>
  <span style="color: #ff1493;">(</span><span style="color: #96a5d9; font-weight: bold;">let*</span> <span style="color: #7fff00;">(</span><span style="color: #00bfff;">(</span>source-code <span style="color: #ffff00;">(</span>buffer-substring-no-properties <span style="color: #da70d6;">(</span>point-min<span style="color: #da70d6;">)</span> <span style="color: #da70d6;">(</span>point-max<span style="color: #da70d6;">)</span><span style="color: #ffff00;">)</span><span style="color: #00bfff;">)</span>
      <span style="color: #00bfff;">(</span>raw-tokens <span style="color: #ffff00;">(</span>elk-parse source-code<span style="color: #ffff00;">)</span><span style="color: #00bfff;">)</span>
      <span style="color: #00bfff;">(</span>token-table <span style="color: #ffff00;">(</span>elk-magic--create-token-table raw-tokens<span style="color: #ffff00;">)</span><span style="color: #00bfff;">)</span>
      <span style="color: #00bfff;">(</span>just-tokens <span style="color: #ffff00;">(</span>elk-magic--discard-filler raw-tokens<span style="color: #ffff00;">)</span><span style="color: #00bfff;">)</span>
      <span style="color: #00bfff;">(</span>interface-expression-p
       <span style="color: #ffff00;">(</span><span style="color: #96a5d9; font-weight: bold;">lambda</span> <span style="color: #da70d6;">(</span>expression<span style="color: #da70d6;">)</span>
         <span style="color: #da70d6;">(</span><span style="color: #96a5d9; font-weight: bold;">let*</span> <span style="color: #00ff7f;">(</span><span style="color: #ff8247;">(</span>sub-tokens <span style="color: #9cb6ad;">(</span>plist-get expression <span style="color: #96a5d9; font-style: italic;">:tokens</span><span style="color: #9cb6ad;">)</span><span style="color: #ff8247;">)</span>
             <span style="color: #ff8247;">(</span>header-atom <span style="color: #9cb6ad;">(</span>nth 0 sub-tokens<span style="color: #9cb6ad;">)</span><span style="color: #ff8247;">)</span>
             <span style="color: #ff8247;">(</span>name-atom <span style="color: #9cb6ad;">(</span>nth 1 sub-tokens<span style="color: #9cb6ad;">)</span><span style="color: #ff8247;">)</span>
             <span style="color: #ff8247;">(</span>header-text <span style="color: #9cb6ad;">(</span>plist-get header-atom <span style="color: #96a5d9; font-style: italic;">:text</span><span style="color: #9cb6ad;">)</span><span style="color: #ff8247;">)</span>
             <span style="color: #ff8247;">(</span>name-text <span style="color: #9cb6ad;">(</span>plist-get name-atom <span style="color: #96a5d9; font-style: italic;">:text</span><span style="color: #9cb6ad;">)</span><span style="color: #ff8247;">)</span><span style="color: #00ff7f;">)</span>
           <span style="color: #00ff7f;">(</span><span style="color: #96a5d9; font-weight: bold;">or</span> <span style="color: #ff8247;">(</span>string-equal header-text <span style="color: #68f6cb;">"defun"</span><span style="color: #ff8247;">)</span>
              <span style="color: #ff8247;">(</span>string-equal header-text <span style="color: #68f6cb;">"defvar"</span><span style="color: #ff8247;">)</span><span style="color: #00ff7f;">)</span><span style="color: #da70d6;">)</span><span style="color: #ffff00;">)</span><span style="color: #00bfff;">)</span>
      <span style="color: #00bfff;">(</span>interface-expressions
       <span style="color: #ffff00;">(</span>-filter
        <span style="color: #da70d6;">(</span><span style="color: #96a5d9; font-weight: bold;">lambda</span> <span style="color: #00ff7f;">(</span>token<span style="color: #00ff7f;">)</span>
          <span style="color: #00ff7f;">(</span><span style="color: #96a5d9; font-weight: bold;">and</span> <span style="color: #ff8247;">(</span>eq <span style="color: #9cb6ad;">(</span>plist-get token <span style="color: #96a5d9; font-style: italic;">:type</span><span style="color: #9cb6ad;">)</span> 'expression<span style="color: #ff8247;">)</span>
             <span style="color: #ff8247;">(</span>= <span style="color: #9cb6ad;">(</span>plist-get token <span style="color: #96a5d9; font-style: italic;">:level</span><span style="color: #9cb6ad;">)</span> 1<span style="color: #ff8247;">)</span>
             <span style="color: #ff8247;">(</span>funcall interface-expression-p token<span style="color: #ff8247;">)</span><span style="color: #00ff7f;">)</span><span style="color: #da70d6;">)</span>
        just-tokens<span style="color: #ffff00;">)</span><span style="color: #00bfff;">)</span>
      <span style="color: #00bfff;">(</span>interace-atoms
       <span style="color: #ffff00;">(</span>-map
        <span style="color: #da70d6;">(</span><span style="color: #96a5d9; font-weight: bold;">lambda</span> <span style="color: #00ff7f;">(</span>token<span style="color: #00ff7f;">)</span>
          <span style="color: #00ff7f;">(</span><span style="color: #96a5d9; font-weight: bold;">let*</span> <span style="color: #ff8247;">(</span><span style="color: #9cb6ad;">(</span>interface-atom <span style="color: #ff8c00;">(</span>nth 1 <span style="color: #ff1493;">(</span>plist-get token <span style="color: #96a5d9; font-style: italic;">:tokens</span><span style="color: #ff1493;">)</span><span style="color: #ff8c00;">)</span><span style="color: #9cb6ad;">)</span>
              <span style="color: #9cb6ad;">(</span>interface-text <span style="color: #ff8c00;">(</span>plist-get interface-atom <span style="color: #96a5d9; font-style: italic;">:text</span><span style="color: #ff8c00;">)</span><span style="color: #9cb6ad;">)</span>
              <span style="color: #9cb6ad;">(</span>new-interface-text <span style="color: #ff8c00;">(</span>concat namespace interface-text<span style="color: #ff8c00;">)</span><span style="color: #9cb6ad;">)</span><span style="color: #ff8247;">)</span>
            <span style="color: #ff8247;">(</span>plist-put interface-atom <span style="color: #96a5d9; font-style: italic;">:text</span> new-interface-text<span style="color: #ff8247;">)</span><span style="color: #00ff7f;">)</span><span style="color: #da70d6;">)</span>
        interface-expressions<span style="color: #ffff00;">)</span><span style="color: #00bfff;">)</span><span style="color: #7fff00;">)</span>
    <span style="color: #7fff00;">(</span>elk--codify raw-tokens<span style="color: #7fff00;">)</span><span style="color: #ff1493;">)</span><span style="color: #ff8c00;">)</span>
<span style="color: #2872b2;">; </span><span style="color: #2872b2;">Complexity: 7.2065217391304355(Non-trivial?)</span>
</pre>
</div>

<p>
The code is indeed complicated but it works. Applying it to this code
with <code>(namespace "my-namespace-")</code>, would prefix namespacer with
<code>my-namespace-namespacer</code>. I could paste the code but would be merely
a one line change.
</p>

<p>
The sad thing is that you can do this with a macro and probably be
safer but this shows how you can manipulate the code using the tokens.
This is more of a PoC than anything else. There is too much boiler
plate just to change the function name, there might be a better
paradigm. <a href="http://esprima.org/">Esprima</a> anyone?
</p>
</div>
</div>

<div id="outline-container-orgecc16a5" class="outline-2">
<h2 id="orgecc16a5">Conclusion</h2>
<div class="outline-text-2" id="text-orgecc16a5">
<p>
So nothing much to be impressed&#x2026; for now. I haven't finished the
book yet but now I have a tool to apply some analysis for Elisp. I'm
still looking for ideas about analyzing code at face, not by context.
Code analysis has been done too much, what I am looking at is how code
can be analyzed as a paragraph or as a poem. Automatic summarization
and language processing, is there an analogy for code? We have code
generation and other stuff but how about things that tell you about
the structure or abstract.
</p>

<p>
Maybe I am talking in riddles but I can say this is a fun project
although will little returns. Hmm&#x2026; I wonder what else I can analyze
about the tokens or there proximity.
</p>

<p>
I am a writer. I am a coder. I am a writer and a coder
</p>
</div>
</div>
